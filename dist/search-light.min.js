(function(){'use strict';function a(){}a.prototype={search(b){var c=Object.create(a.prototype,{s_:{value:{matches:[],partial:[],allItems:[],searchText:'',searchTerms:[],keys:[],filters:[],threshold:0,error:!1,errorMessage:'',index:0,lastIndex:0,totalMatches:0,ready:!1,complete:!1,searched:!1}},o_:{value:{collectionType:'array',case:!1,baseThreshold:0,sort:!1,customSort:null,inject:{property:'searchResults',enabled:!1}}}});return c.fn_.collection_.call(c,b)},for(a){return this.s_.searchText='',this.s_.filters=[],this.and(a)},and(a){if(this.s_.ready=!1,this.s_.complete=!1,this.s_.searched=!1,'string'==typeof a)this.s_.searchText=(this.s_.searchText+' '+a).trim();else if('object'==typeof a){var b,c,d;Array.isArray(a)?(b=a[0],c=a[1],d=a[2]):(b=a.key,c=a.operator,d=a.value),'undefined'==typeof d&&(d=c,c='=='),this.s_.filters.push([b,c,d])}else console.warn('Invalid constraint type: ',typeof a);return this},in(a){return this.s_.keys=[],this.or(a)},or(a){return this.s_.ready=!1,this.s_.complete=!1,this.s_.searched=!1,'string'==typeof a?this.s_.keys.push(a):Array.prototype.push.apply(this.s_.keys,a),this},sorted(){return this.o_.sort||(this.o_.sort=!0,this.s_.complete=!1),this},unsorted(){return this.o_.sort&&(this.o_.sort=!1,this.s_.complete=!1),this},sortUsing(a){return this.o_.customSort=a,this.s_.complete=!1,this},compareCase(){return this.o_.case||(this.o_.case=!0,this.s_.complete=!1,this.s_.searched=!1),this},ignoreCase(){return this.o_.case&&(this.o_.case=!1,this.s_.complete=!1,this.s_.searched=!1),this},withStats(a){return this.o_.inject.enabled=!0,'undefined'!=typeof a&&(this.o_.inject.property=a),this},withoutStats(){return this.o_.inject.enabled=!1,this},then(a,b){var c=new Promise(function(a,b){if(this.fn_.updateMatches_.call(this),this.s_.error)b(Error(this.s_.errorMessage));else{var c=this;a({get matches(){return c.matches},get partialMatchess(){return c.partialMatches},get allMatchess(){return c.allMatches}})}}.bind(this));return c.then(a,b),this},catch(a){return this.then(void 0,a)},get length(){return this.fn_.updateMatches_.call(this),this.s_.totalMatches},get matches(){this.fn_.updateMatches_.call(this);var a=this.fn_.toOriginalFormat_.call(this,this.s_.matches);return a},get partialMatches(){return this.fn_.updateMatches_.call(this),this.fn_.performSort_.call(this,this.s_.partial),this.fn_.toOriginalFormat_.call(this,this.s_.partial)},get allMatches(){this.fn_.updateMatches_.call(this);var a=this.s_.matches.concat(this.s_.partial);return this.fn_.performSort_.call(this,a),this.fn_.toOriginalFormat_.call(this,a)},get allItems(){return this.fn_.updateMatches_.call(this),this.fn_.performSort_.call(this,this.s_.allItems),this.fn_.toOriginalFormat_.call(this,this.s_.allItems)},[Symbol.iterator](){return this.updateMatches_(),this.o_.inject.enabled?{next:this.i_.nextInject_.bind(this)}:{next:this.i_.next_.bind(this)}},fn_:{collection_(a){var b=[];return Array.isArray(a)?b=Array.from(a.keys()):'object'==typeof a?(b=Object.keys(a).filter((b)=>a.hasOwnProperty(b)),this.o_.collectionType='object'):(this.s_.error=!0,this.s_.errorMessage='Invalid collection type: '+typeof a,console.warn(this.s_.errorMessage)),this.s_.collection=new Map(b.map(this.i_.collection_.bind(this,a))),this.s_.complete=!1,this.s_.searched=!1,this},performSearch_(){this.fn_.isConstrained.call(this)?(this.s_.allItems=[],this.s_.matches=[],this.s_.partial=[],this.s_.collection.forEach(this.i_.calculateRelevance_.bind(this))):(this.s_.allItems=Array.from(this.s_.collection.keys()).map(this.i_.emptyMatch_),this.s_.matches=this.s_.allItems,this.s_.partial=[]),this.s_.searched=!0},updateMatches_(){this.s_.complete||(!this.s_.searched&&this.fn_.performSearch_.call(this),this.fn_.performSort_.call(this,this.s_.matches),this.s_.totalMatches=this.s_.matches.length,this.s_.index=0,this.s_.lastIndex=this.s_.totalMatches-1,this.s_.complete=!0)},performSort_(a){this.o_.sort&&this.fn_.isConstrained.call(this)&&a.length&&a.sort(this.i_.sortComparator_),null!==this.o_.customSort&&a.sort(this.o_.customSort.bind(null,this.fn_.getItem_.bind(this)))},getItem_(a){return this.s_.collection.get(a[0])},getItemInject_(a){var b=this.s_.collection.get(a[0]);return Array.isArray(b)?b.push({relevance:a[1],missing:a[2]}):'object'==typeof b&&(b[this.o_.inject.property]={relevance:a[1],missing:a[2]}),b},toOriginalFormat_(a){return'array'===this.o_.collectionType?this.o_.inject.enabled?a.map(this.fn_.getItemInject_,this):a.map(this.fn_.getItem_,this):this.o_.inject.enabled?a.reduce(this.i_.reduceInject_.bind(this),{}):a.reduce(this.i_.reduce_.bind(this),{})},updateConstraints_(){this.s_.ready||(this.s_.searchTerms=''===this.s_.searchText?[]:(this.o_.case?this.s_.searchText:this.s_.searchText.toLowerCase()).split(' '),this.s_.threshold=this.o_.baseThreshold+this.s_.filters.length+(0<this.s_.searchTerms.length),this.s_.ready=!0)},isConstrained(){return this.fn_.updateConstraints_.call(this),this.s_.searchTerms.length||this.s_.filters.length}},i_:{collection_(a,b){return[b,a[b]]},next_(){return this.s_.index>this.s_.lastIndex?{done:!0}:{done:!1,value:this.fn_.getItem_(this.s_.matches[this.s_.index++])}},nextInject_(){return this.s_.index>this.s_.lastIndex?{done:!0}:{done:!1,value:this.fn_.getItemInject_(this.s_.matches[this.s_.index++])}},property_(a,b){return a[b]||null},search_(a,b,c){var d=b.split(c).length-1;d?a[1]+=d:a[2]+=' '+c},filter_(a,b,c){var d=c[0],e=c[1],f=c[2];'string'!=typeof a&&('=='===e?b[1]+=a[d]==f:'==='===e?b[1]+=a[d]===f:'!='===e?b[1]+=a[d]!=f:'!=='===e?b[1]+=a[d]!==f:'>'===e?b[1]+=a[d]>f:'>='===e?b[1]+=a[d]>=f:'<'===e?b[1]+=a[d]<f:'<='===e?b[1]+=a[d]<=f:'%'===e?b[1]+=-1!==a[d].indexOf(f):'!%'===e?b[1]+=-1===a[d].indexOf(f):console.warn('Invalid filter operator:',e))},calculateRelevance_(a,b){var c=[b,0,''],d='';this.s_.filters.forEach(this.i_.filter_.bind(this,a,c)),d='string'==typeof a?a:this.s_.keys.length?this.s_.keys.map(this.i_.property_.bind(this,a)).join('|'):Array.isArray(a)?a.join('|'):Object.keys(a).reduce(this.i_.reduceProperties_.bind(this,a),''),this.o_.case||(d=d.toLowerCase()),this.s_.searchTerms.forEach(this.i_.search_.bind(this,c,d)),this.s_.allItems.push(c),0===c[1]||(c[1]<this.s_.threshold?this.s_.partial.push(c):this.s_.matches.push(c))},emptyMatch_(a){return[a,0,'']},reduce_(a,b){return a[b[0]]=this.fn_.getItem_.call(this,b),a},reduceInject_(a,b){return a[b[0]]=this.fn_.getItemInject_.call(this,b),a},reduceProperties_(a,b,c){return b+='|'+a[c],b},sortComparator_(a,b){return b[1]>a[1]?1:b[1]===a[1]?b[0]<a[0]:-1}}},'undefined'!=typeof window&&(window.searchLight={search:a.prototype.search}),'undefined'!=typeof module&&'undefined'!=typeof module.exports&&(module.exports.search=a.prototype.search)})();